<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MonDuck Compiler Pro</title>

  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- CodeMirror Styles & Theme -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

  <!-- Language Modes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/go/go.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/ruby/ruby.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/r/r.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>

  <style>
    body {
      font-family: 'Fira Code', monospace;
    }

    .CodeMirror {
      height: 100%;
      font-size: 0.95rem;
    }

    .CodeMirror-vscrollbar,
    .CodeMirror-hscrollbar {
      background-color: #2d2d2d;
    }

    .CodeMirror-scroll {
      background-color: #1e1e1e !important;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #2d2d2d;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    #visualizer-modal {
      position: fixed;
      z-index: 9999;
      top: 0;
      right: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(30, 30, 30, 0.30);
      display: flex;
      align-items: stretch;
      justify-content: flex-end;
      transition: background 0.3s;
    }

    #visualizer-backdrop {
      flex: 1;
      cursor: pointer;
    }

    #visualizer-popup {
      width: 600px;
      max-width: 95vw;
      height: 100vh;
      background: #191a21;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.8);
      resize: both;
      overflow: auto;
      position: relative;
      transform: translateX(100%);
      animation: slideIn 0.5s forwards;
      display: flex;
      flex-direction: column;
    }

    #visualizer-close {
      position: absolute;
      right: 10px;
      top: 7px;
      z-index: 2;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.7em;
      cursor: pointer;
    }

    #visualizer-popup-content {
      padding: 20px 5px 5px 5px;
      flex: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }

      to {
        transform: translateX(0);
      }
    }

    .complexity-info {
      background: #1a1a2e;
      border-left: 4px solid #f39c12;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }

    .complexity-label {
      color: #f39c12;
      font-weight: bold;
      margin-right: 8px;
    }

    .complexity-value {
      color: #00ff9d;
    }

    /* CodePen Modal Styles */
    #codepen-modal {
      position: fixed;
      z-index: 10000;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      flex-direction: column;
    }

    #codepen-modal.active {
      display: flex;
    }

    .codepen-header {
      background: #1e1e1e;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #333;
    }

    .codepen-header h2 {
      color: #47cf73;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .codepen-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .codepen-btn {
      background: #47cf73;
      color: #000;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    .codepen-btn:hover {
      background: #3bb862;
    }

    .codepen-btn.secondary {
      background: #555;
      color: #fff;
    }

    .codepen-btn.secondary:hover {
      background: #666;
    }

    .codepen-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .codepen-editors {
      display: flex;
      flex-direction: column;
      flex: 1;
      background: #1e1e1e;
    }

    .codepen-editor-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid #333;
      min-height: 0;
    }

    .codepen-editor-panel:last-child {
      border-bottom: none;
    }

    .codepen-editor-header {
      background: #2d2d2d;
      padding: 8px 16px;
      color: #fff;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #444;
    }

    .codepen-editor-header i {
      color: #47cf73;
    }

    .codepen-editor {
      flex: 1;
      overflow: hidden;
    }

    .codepen-preview {
      flex: 1;
      background: #fff;
      border-left: 2px solid #333;
      display: flex;
      flex-direction: column;
    }

    .codepen-preview-header {
      background: #2d2d2d;
      padding: 8px 16px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #444;
    }

    .codepen-preview-frame {
      flex: 1;
      border: none;
      background: #fff;
    }

    .input-section {
      background: #1e1e1e;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .input-section label {
      display: block;
      color: #f39c12;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .input-section textarea {
      width: 100%;
      background: #2d2d2d;
      color: #00ff9d;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px;
      font-family: 'Fira Code', monospace;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 60px;
    }

    .input-section textarea:focus {
      outline: none;
      border-color: #f39c12;
    }

    @media (max-width: 768px) {
      .codepen-container {
        flex-direction: column;
      }

      .codepen-preview {
        border-left: none;
        border-top: 2px solid #333;
      }
    }
  </style>
</head>

<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

  <header class="bg-gray-800 p-4 flex flex-col md:flex-row justify-between items-center shadow-md">
    <h1 class="text-2xl font-bold text-yellow-500 mb-4 md:mb-0 flex items-center">
      <i class="fa fa-rocket mr-3"></i> MonDuck Compiler Pro
    </h1>

    <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
      <button id="codepen-btn"
        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out w-full md:w-auto">
        <i class="fa fa-code mr-2"></i> CodePen Mode
      </button>

      <button id="visualizeBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out w-full md:w-auto">
        <i class="fa fa-eye mr-2"></i> Visualize Code
      </button>

      <div class="flex items-center space-x-2">
        <label for="language" class="text-gray-300">Language:</label>
        <select id="language"
          class="bg-gray-700 text-white border border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option value="62">Java</option>
          <option value="71">Python 3</option>
          <option value="54">C++</option>
          <option value="50">C</option>
          <option value="63">JavaScript (Node.js)</option>
          <option value="78">Kotlin</option>
          <option value="60">Go</option>
          <option value="72">Ruby</option>
          <option value="46">Bash</option>
          <option value="80">R</option>
          <option value="68">PHP</option>
          <option value="65">OCaml</option>
          <option value="75">Swift</option>
        </select>
      </div>

      <button id="run-btn"
        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out w-full md:w-auto">
        <i class="fa fa-play mr-2"></i> Run & Analyze
      </button>
    </div>
  </header>

  <main class="flex-grow flex flex-col md:flex-row">
    <div id="editor-container" class="flex-grow md:w-3/4 flex flex-col h-full border-r border-gray-700">
      <textarea id="editor" class="flex-grow">// Write your code here...</textarea>
    </div>

    <div id="output-panel" class="md:w-1/4 flex flex-col bg-gray-800">
      <!-- Input Section -->
      <div class="input-section">
        <label for="stdin-input">
          <i class="fa fa-keyboard mr-1"></i> Program Input (stdin):
        </label>
        <textarea id="stdin-input" placeholder="Enter input for your program here (one value per line)..."></textarea>
      </div>

      <div id="output" class="flex-grow p-4 overflow-auto flex items-center justify-center">
        <div id="result" class="w-full text-center">
          <div class="text-gray-400 text-sm">Click "Run & Analyze" to execute your code...</div>
        </div>
      </div>
      <div id="visualizer-output"></div>
    </div>
  </main>

  <footer class="text-center text-gray-400 text-sm p-3 bg-gray-800 border-t border-gray-700">
    ‚öôÔ∏è Built with HTML, CSS, JS & Judge0 API | Enhanced with Visualization
  </footer>

  <!-- Popup/slide visualizer modal -->
  <div id="visualizer-modal" style="display:none;">
    <div id="visualizer-backdrop"></div>
    <div id="visualizer-popup">
      <button id="visualizer-close"><i class="fa fa-times"></i></button>
      <div id="visualizer-popup-content"></div>
    </div>
  </div>

  <!-- CodePen Modal -->
  <div id="codepen-modal">
    <div class="codepen-header">
      <h2><i class="fa fa-code"></i> HTML/CSS/JS Live Editor</h2>
      <div class="codepen-controls">
        <button id="codepen-run-btn" class="codepen-btn">
          <i class="fa fa-play"></i> Run
        </button>
        <button id="codepen-close-btn" class="codepen-btn secondary">
          <i class="fa fa-times"></i> Close
        </button>
      </div>
    </div>

    <div class="codepen-container">
      <div class="codepen-editors">
        <!-- HTML Editor -->
        <div class="codepen-editor-panel">
          <div class="codepen-editor-header">
            <i class="fab fa-html5"></i>
            <span>HTML</span>
          </div>
          <div class="codepen-editor">
            <textarea id="html-editor"></textarea>
          </div>
        </div>

        <!-- CSS Editor -->
        <div class="codepen-editor-panel">
          <div class="codepen-editor-header">
            <i class="fab fa-css3-alt"></i>
            <span>CSS</span>
          </div>
          <div class="codepen-editor">
            <textarea id="css-editor"></textarea>
          </div>
        </div>

        <!-- JS Editor -->
        <div class="codepen-editor-panel">
          <div class="codepen-editor-header">
            <i class="fab fa-js"></i>
            <span>JavaScript</span>
          </div>
          <div class="codepen-editor">
            <textarea id="js-editor"></textarea>
          </div>
        </div>
      </div>

      <!-- Preview Panel -->
      <div class="codepen-preview">
        <div class="codepen-preview-header">
          <span><i class="fa fa-desktop"></i> Preview</span>
          <button id="codepen-refresh-btn" class="codepen-btn">
            <i class="fa fa-sync"></i> Refresh
          </button>
        </div>
        <iframe id="preview-frame" class="codepen-preview-frame"></iframe>
      </div>
    </div>
  </div>

  <script>
    // Show visualizer in a slide-out modal popup
    document.getElementById('visualizeBtn').addEventListener('click', () => {
      const code = editor.getValue().trim();
      const langId = languageSelect.value;
      const popupDiv = document.getElementById('visualizer-popup-content');
      const modal = document.getElementById('visualizer-modal');

      // Support for Python 3 and Java
      if (langId === "71") {
        // Python visualization
        const url = 'https://pythontutor.com/visualize.html#code=' +
          encodeURIComponent(code) +
          '&cumulative=false&heapPrimitives=nevernest&mode=display&origin=opt-frontend.js&py=3&rawInputLstJSON=%5B%5D&textReferences=false';

        popupDiv.innerHTML = `
          <iframe src="${url}" class="w-full h-full border-2 border-gray-700 bg-gray-900 rounded-md"></iframe>
          <div class="text-xs mt-2 text-gray-500 p-2">
            Powered by <a href="https://pythontutor.com" target="_blank" class="text-yellow-500 hover:underline">Python Tutor</a>.
          </div>
        `;
      } else if (langId === "62") {
        // Java visualization
        const url = 'https://pythontutor.com/java.html#code=' +
          encodeURIComponent(code) +
          '&cumulative=false&heapPrimitives=nevernest&mode=display&origin=opt-frontend.js&textReferences=false';

        popupDiv.innerHTML = `
          <iframe src="${url}" class="w-full h-full border-2 border-gray-700 bg-gray-900 rounded-md"></iframe>
          <div class="text-xs mt-2 text-gray-500 p-2">
            Powered by <a href="https://pythontutor.com/java.html" target="_blank" class="text-yellow-500 hover:underline">Java Tutor</a>.
          </div>
        `;
      } else if (langId === "54" || langId === "50") {
        // C/C++ visualization
        const langParam = langId === "54" ? "cpp" : "c";
        const url = `https://pythontutor.com/${langParam}.html#code=` +
          encodeURIComponent(code) +
          '&cumulative=false&heapPrimitives=nevernest&mode=display&origin=opt-frontend.js&textReferences=false';

        popupDiv.innerHTML = `
          <iframe src="${url}" class="w-full h-full border-2 border-gray-700 bg-gray-900 rounded-md"></iframe>
          <div class="text-xs mt-2 text-gray-500 p-2">
            Powered by <a href="https://pythontutor.com" target="_blank" class="text-yellow-500 hover:underline">Python Tutor</a>.
          </div>
        `;
      } else if (langId === "63") {
        // JavaScript visualization
        const url = 'https://pythontutor.com/javascript.html#code=' +
          encodeURIComponent(code) +
          '&cumulative=false&heapPrimitives=nevernest&mode=display&origin=opt-frontend.js&textReferences=false';

        popupDiv.innerHTML = `
          <iframe src="${url}" class="w-full h-full border-2 border-gray-700 bg-gray-900 rounded-md"></iframe>
          <div class="text-xs mt-2 text-gray-500 p-2">
            Powered by <a href="https://pythontutor.com" target="_blank" class="text-yellow-500 hover:underline">JavaScript Tutor</a>.
          </div>
        `;
      } else {
        popupDiv.innerHTML = `
          <div class="p-6 text-center">
            <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
            <h3 class="text-xl text-red-500 mb-2">Visualization Not Available</h3>
            <p class="text-gray-400">Visualizer is currently supported for:</p>
            <ul class="text-yellow-400 mt-2">
              <li>‚úì Python 3</li>
              <li>‚úì Java</li>
              <li>‚úì C/C++</li>
              <li>‚úì JavaScript</li>
            </ul>
          </div>
        `;
      }
      modal.style.display = "flex";
    });

    // Close popup when clicking X or background
    document.getElementById('visualizer-close').onclick =
      document.getElementById('visualizer-backdrop').onclick = function () {
        document.getElementById('visualizer-modal').style.display = "none";
      };

    const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
      mode: "text/x-java",
      theme: "dracula",
      lineNumbers: true,
      autoCloseBrackets: true,
      matchBrackets: true,
      indentUnit: 4,
      smartIndent: true,
      lineWrapping: true,
    });

    const languageSelect = document.getElementById("language");
    const result = document.getElementById("result");
    const runBtn = document.getElementById("run-btn");
    const stdinInput = document.getElementById("stdin-input");

    // Judge0 API Configuration
    const RAPIDAPI_KEY = "0f910b094amsh5118396153e685cp1d989fjsn2bed2da8ad6e";
    const RAPIDAPI_HOST = "judge0-ce.p.rapidapi.com";

    // Example code snippets
    const exampleCodes = {
      "62": `import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        
        System.out.print("Enter your name: ");
        String name = scanner.nextLine();
        
        System.out.print("Enter a number: ");
        int num = scanner.nextInt();
        
        System.out.println("Hello, " + name + "!");
        System.out.println("Your number squared is: " + (num * num));
        
        scanner.close();
    }
}`,
      "71": `# Python example with input
name = input("Enter your name: ")
age = int(input("Enter your age: "))

print(f"Hello, {name}!")
print(f"In 10 years, you'll be {age + 10} years old.")

# Factorial example
def factorial(n):
    if n == 0 or n == 1:
        return 1
    return n * factorial(n - 1)

num = int(input("Enter a number for factorial: "))
print(f"Factorial of {num} is {factorial(num)}")`,
      "54": `#include <iostream>
#include <string>
using namespace std;

int main() {
    string name;
    int num;
    
    cout << "Enter your name: ";
    getline(cin, name);
    
    cout << "Enter a number: ";
    cin >> num;
    
    cout << "Hello, " << name << "!" << endl;
    cout << "Your number squared is: " << (num * num) << endl;
    
    return 0;
}`,
      "50": `#include <stdio.h>

int main() {
    char name[100];
    int num;
    
    printf("Enter your name: ");
    fgets(name, 100, stdin);
    
    printf("Enter a number: ");
    scanf("%d", &num);
    
    printf("Hello, %s", name);
    printf("Your number squared is: %d\\n", num * num);
    
    return 0;
}`,
      "63": `const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
});

function greet(name) {
    console.log("Hello, " + name + "!");
}

readline.question('Enter your name: ', name => {
    greet(name);
    readline.close();
});`,
      "78": `fun main() {
    print("Enter your name: ")
    val name = readLine()
    
    print("Enter a number: ")
    val num = readLine()?.toIntOrNull() ?: 0
    
    println("Hello, \$name!")
    println("Your number squared is: \${num * num}")
}`,
      "60": `package main
import (
    "fmt"
    "bufio"
    "os"
)

func main() {
    reader := bufio.NewReader(os.Stdin)
    
    fmt.Print("Enter your name: ")
    name, _ := reader.ReadString('\\n')
    
    fmt.Println("Hello,", name)
}`,
      "72": `puts "Enter your name:"
name = gets.chomp

puts "Enter a number:"
num = gets.chomp.to_i

puts "Hello, #{name}!"
puts "Your number squared is: #{num * num}"`,
      "46": `echo "Enter your name:"
read name
echo "Hello, $name!"`,
      "80": `cat("Enter a number: ")
x <- as.numeric(readLines("stdin", n=1))
print(paste("Your number squared is:", x * x))`,
      "68": `<?php
$name = readline("Enter your name: ");
$num = readline("Enter a number: ");

echo "Hello, " . $name . "!\\n";
echo "Your number squared is: " . ($num * $num) . "\\n";
?>`,
      "65": `print_string "Enter your name: ";;
let name = read_line() in
print_endline ("Hello, " ^ name ^ "!");;`,
      "75": `import Foundation

print("Enter your name: ", terminator: "")
if let name = readLine() {
    print("Hello, \\(name)!")
}`
    };

    // Example stdin inputs
    const exampleStdin = {
      "62": "John Doe\n5",
      "71": "Alice\n25\n5",
      "54": "Bob\n7",
      "50": "Charlie\n10",
      "63": "David",
      "78": "Emma\n8",
      "60": "Frank",
      "72": "Grace\n3",
      "46": "Henry",
      "80": "9",
      "68": "Ivy\n6",
      "65": "Jack",
      "75": "Kate"
    };

    // Change editor mode and load sample code dynamically
    languageSelect.addEventListener("change", () => {
      const langId = languageSelect.value;

      if (langId === "62") editor.setOption("mode", "text/x-java");
      else if (langId === "54" || langId === "50") editor.setOption("mode", "text/x-c++src");
      else if (langId === "71") editor.setOption("mode", "text/x-python");
      else if (langId === "63") editor.setOption("mode", "javascript");
      else if (langId === "78") editor.setOption("mode", "text/x-kotlin");
      else if (langId === "60") editor.setOption("mode", "go");
      else if (langId === "72") editor.setOption("mode", "text/x-ruby");
      else if (langId === "46") editor.setOption("mode", "shell");
      else if (langId === "80") editor.setOption("mode", "text/x-rsrc");
      else if (langId === "68") editor.setOption("mode", "application/x-httpd-php");
      else editor.setOption("mode", "text/plain");

      editor.setValue(exampleCodes[langId] || "// Write your code here...");
      stdinInput.value = exampleStdin[langId] || "";
    });

    // Run code via Judge0 API with stdin support
    async function createSubmission(code, languageId, stdin) {
      const url = `https://${RAPIDAPI_HOST}/submissions?base64_encoded=false&wait=true`;
      const payload = {
        source_code: code,
        language_id: parseInt(languageId),
        stdin: stdin || ""
      };

      const response = await fetch(url, {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "X-RapidAPI-Key": RAPIDAPI_KEY,
          "X-RapidAPI-Host": RAPIDAPI_HOST
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error(`HTTP error ${response.status}`);
      return await response.json();
    }

    // Enhanced complexity analysis
    function performComplexityAnalysis(code) {
      const lines = code.split('\n').filter(line => line.trim() !== '');
      const loops = (code.match(/\bfor\b|\bwhile\b|\bdo\b/g) || []).length;

      // Detect recursive patterns
      const functionNames = [...code.matchAll(/(?:def|function|func|public\s+static\s+\w+)\s+(\w+)/g)].map(m => m[1]);
      let recursiveCalls = 0;
      functionNames.forEach(fname => {
        const regex = new RegExp(`\\b${fname}\\s*\\(`, 'g');
        const matches = code.match(regex) || [];
        if (matches.length > 1) recursiveCalls++;
      });

      let timeComplexity = "O(1)";
      let spaceComplexity = "O(1)";
      let algorithm = "Linear Code";
      let description = "Sequential execution with constant operations.";

      // Detect data structures
      const hasArrays = /\[\s*\]|ArrayList|Vector|List|Array\s*<|array\(/.test(code);
      const hasHashMap = /HashMap|Map|dict|set\(|Set</.test(code);
      const hasStack = /Stack|stack/.test(code);
      const hasQueue = /Queue|queue/.test(code);
      const hasTree = /Tree|TreeNode|Node/.test(code);

      if (recursiveCalls > 0) {
        algorithm = "Recursive Algorithm";
        if (code.includes('fibonacci') || /fib/i.test(code)) {
          timeComplexity = "O(2^n)";
          description = "Exponential time - Fibonacci recursion without memoization.";
        } else if (code.includes('factorial')) {
          timeComplexity = "O(n)";
          description = "Linear recursion for factorial computation.";
        } else if (hasTree) {
          timeComplexity = "O(n)";
          description = "Tree traversal - visits each node once.";
        } else {
          timeComplexity = "O(2^n) or O(n!)";
          description = "Potentially high recursive complexity.";
        }
        spaceComplexity = "O(n)";
      } else if (loops >= 3) {
        algorithm = "Nested Loop Algorithm";
        timeComplexity = "O(n¬≥) or higher";
        description = "Triple nested loops - cubic time complexity.";
        spaceComplexity = hasArrays ? "O(n)" : "O(1)";
      } else if (loops === 2) {
        algorithm = "Nested Loop Algorithm";
        timeComplexity = "O(n¬≤)";
        description = "Double nested loops - quadratic time complexity.";
        spaceComplexity = hasArrays ? "O(n)" : "O(1)";
      } else if (loops === 1) {
        algorithm = "Single Loop Algorithm";
        timeComplexity = "O(n)";
        description = "Single iteration through data - linear time complexity.";
        spaceComplexity = hasArrays ? "O(n)" : "O(1)";
      }

      // Detect specific algorithms
      if (/sort/i.test(code)) {
        algorithm = "Sorting Algorithm";
        if (/quicksort|mergesort/i.test(code)) {
          timeComplexity = "O(n log n)";
          description = "Efficient divide-and-conquer sorting.";
        } else if (/bubblesort|selectionsort|insertionsort/i.test(code)) {
          timeComplexity = "O(n¬≤)";
          description = "Basic comparison-based sorting.";
        } else {
          timeComplexity = "O(n log n)";
          description = "Typical efficient sorting algorithm.";
        }
        spaceComplexity = "O(n)";
      }

      if (/binary.*search/i.test(code)) {
        algorithm = "Binary Search";
        timeComplexity = "O(log n)";
        description = "Logarithmic search on sorted data.";
      }

      if (hasHashMap) {
        spaceComplexity = "O(n)";
        if (timeComplexity === "O(1)") {
          timeComplexity = "O(n)";
          description = "Hash-based data structure with linear space.";
        }
      }

      if (hasStack || hasQueue) {
        spaceComplexity = "O(n)";
        algorithm = hasStack ? "Stack-based Algorithm" : "Queue-based Algorithm";
      }

      if (hasTree) {
        spaceComplexity = "O(n)";
        if (algorithm === "Linear Code") {
          algorithm = "Tree Algorithm";
          timeComplexity = "O(n)";
          description = "Tree traversal or manipulation.";
        }
      }

      return {
        algorithm: algorithm,
        timeComplexity: timeComplexity,
        spaceComplexity: spaceComplexity,
        description: description,
        linesOfCode: lines.length,
        loopCount: loops,
        isRecursive: recursiveCalls > 0
      };
    }

    // Format comprehensive output with 4 distinct sections
    function formatCompleteOutput(complexityData, executionData) {
      const executionTime = executionData.time ? parseFloat(executionData.time).toFixed(3) : "N/A";
      const memory = executionData.memory ? (executionData.memory / 1024).toFixed(2) : "N/A";
      const status = executionData.status?.description || "Unknown";

      let output = `
<div class="space-y-4 text-left">
  <!-- Section 1: Input Values -->
  <div class="bg-gradient-to-r from-purple-900 to-purple-800 p-4 rounded-lg border-l-4 border-purple-400 shadow-lg">
    <h4 class="text-lg font-bold text-purple-200 mb-3 flex items-center">
      <i class="fa fa-keyboard mr-2"></i> 1. Input Values
    </h4>
    <div class="bg-gray-900 p-3 rounded-md">
      <pre class="text-purple-300 text-sm">${stdinInput.value || "(No input provided)"}</pre>
    </div>
  </div>

  <!-- Section 2: Program Output -->
  <div class="bg-gradient-to-r from-green-900 to-green-800 p-4 rounded-lg border-l-4 border-green-400 shadow-lg">
    <h4 class="text-lg font-bold text-green-200 mb-3 flex items-center">
      <i class="fa fa-terminal mr-2"></i> 2. Program Output
    </h4>
    <div class="bg-gray-900 p-3 rounded-md">
      <pre class="text-green-400 text-sm overflow-x-auto">${executionData.stdout || executionData.stderr || executionData.compile_output || "No output"}</pre>
    </div>
  </div>

  <!-- Section 3: Time & Space Complexity -->
  <div class="bg-gradient-to-r from-yellow-900 to-yellow-800 p-4 rounded-lg border-l-4 border-yellow-400 shadow-lg">
    <h4 class="text-lg font-bold text-yellow-200 mb-3 flex items-center">
      <i class="fa fa-chart-line mr-2"></i> 3. Time & Space Complexity
    </h4>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="bg-gray-900 p-3 rounded-md">
        <div class="text-yellow-300 text-sm font-semibold mb-1">‚è±Ô∏è Time Complexity:</div>
        <div class="text-green-400 text-2xl font-bold">${complexityData.timeComplexity}</div>
      </div>
      <div class="bg-gray-900 p-3 rounded-md">
        <div class="text-yellow-300 text-sm font-semibold mb-1">üíæ Space Complexity:</div>
        <div class="text-green-400 text-2xl font-bold">${complexityData.spaceComplexity}</div>
      </div>
    </div>
    <div class="mt-3 bg-gray-900 p-3 rounded-md">
      <div class="text-yellow-300 text-sm font-semibold mb-1">üîç Algorithm Type:</div>
      <div class="text-white">${complexityData.algorithm}</div>
    </div>
    <div class="mt-2 bg-gray-900 p-3 rounded-md">
      <div class="text-yellow-300 text-sm font-semibold mb-1">üìù Description:</div>
      <div class="text-gray-300 text-sm">${complexityData.description}</div>
    </div>
  </div>

  <!-- Section 4: Execution Metrics -->
  <div class="bg-gradient-to-r from-blue-900 to-blue-800 p-4 rounded-lg border-l-4 border-blue-400 shadow-lg">
    <h4 class="text-lg font-bold text-blue-200 mb-3 flex items-center">
      <i class="fa fa-tachometer-alt mr-2"></i> 4. Execution Metrics
    </h4>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="bg-gray-900 p-3 rounded-md text-center">
        <div class="text-blue-300 text-xs font-semibold mb-1">‚ö° EXECUTION TIME</div>
        <div class="text-green-400 text-xl font-bold">${executionTime}s</div>
      </div>
      <div class="bg-gray-900 p-3 rounded-md text-center">
        <div class="text-blue-300 text-xs font-semibold mb-1">üß† MEMORY USED</div>
        <div class="text-green-400 text-xl font-bold">${memory} KB</div>
      </div>
      <div class="bg-gray-900 p-3 rounded-md text-center">
        <div class="text-blue-300 text-xs font-semibold mb-1">‚úÖ STATUS</div>
        <div class="text-${status.includes('Accepted') ? 'green' : 'red'}-400 text-xl font-bold">${status}</div>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
      <div class="bg-gray-900 p-3 rounded-md text-center">
        <div class="text-blue-300 text-xs font-semibold mb-1">üìä LINES OF CODE</div>
        <div class="text-yellow-400 text-xl font-bold">${complexityData.linesOfCode}</div>
      </div>
      <div class="bg-gray-900 p-3 rounded-md text-center">
        <div class="text-blue-300 text-xs font-semibold mb-1">üîÑ LOOP COUNT</div>
        <div class="text-yellow-400 text-xl font-bold">${complexityData.loopCount}</div>
      </div>
      <div class="bg-gray-900 p-3 rounded-md text-center">
        <div class="text-blue-300 text-xs font-semibold mb-1">‚ôªÔ∏è RECURSIVE</div>
        <div class="text-${complexityData.isRecursive ? 'red' : 'green'}-400 text-xl font-bold">${complexityData.isRecursive ? 'YES' : 'NO'}</div>
      </div>
    </div>
  </div>
</div>
`;

      return output;
    }

    // Run & Analyze button - combined functionality
    runBtn.addEventListener("click", async () => {
      const code = editor.getValue().trim();
      const languageId = languageSelect.value;
      const stdin = stdinInput.value;

      if (!code) {
        result.innerHTML = "<span class='text-red-500'>Please write some code!</span>";
        return;
      }

      result.innerHTML = `
        <div class="text-blue-400 flex items-center justify-center p-4">
          <i class="fa fa-spinner fa-spin mr-2 text-2xl"></i>
          <span>Running code and analyzing complexity...</span>
        </div>
      `;
      runBtn.disabled = true;

      try {
        const executionData = await createSubmission(code, languageId, stdin);
        const complexityData = performComplexityAnalysis(code);
        result.innerHTML = formatCompleteOutput(complexityData, executionData);
      } catch (err) {
        result.innerHTML = `
          <div class="text-red-500">
            <i class="fa fa-exclamation-triangle mr-2"></i>
            <strong>Error:</strong> ${err.message}
          </div>
        `;
      } finally {
        runBtn.disabled = false;
      }
    });

    // Default code on page load
    editor.setValue(exampleCodes["62"]);
    stdinInput.value = exampleStdin["62"];

    // ==================== CODEPEN MODE ====================

    let htmlEditor, cssEditor, jsEditor;
    const codepenModal = document.getElementById('codepen-modal');
    const codepenBtn = document.getElementById('codepen-btn');
    const codepenCloseBtn = document.getElementById('codepen-close-btn');
    const codepenRunBtn = document.getElementById('codepen-run-btn');
    const codepenRefreshBtn = document.getElementById('codepen-refresh-btn');
    const previewFrame = document.getElementById('preview-frame');

    // Initialize CodePen editors
    function initializeCodePenEditors() {
      htmlEditor = CodeMirror.fromTextArea(document.getElementById("html-editor"), {
        mode: "htmlmixed",
        theme: "dracula",
        lineNumbers: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 2,
        smartIndent: true,
        lineWrapping: true,
      });

      cssEditor = CodeMirror.fromTextArea(document.getElementById("css-editor"), {
        mode: "css",
        theme: "dracula",
        lineNumbers: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 2,
        smartIndent: true,
        lineWrapping: true,
      });

      jsEditor = CodeMirror.fromTextArea(document.getElementById("js-editor"), {
        mode: "javascript",
        theme: "dracula",
        lineNumbers: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 2,
        smartIndent: true,
        lineWrapping: true,
      });

      // Set default sample code
      htmlEditor.setValue(`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Editor</title>
</head>
<body>
  <div class="container">
    <h1>Hello, CodePen!</h1>
    <p>Edit the HTML, CSS, and JavaScript to see changes live.</p>
    <button id="clickBtn">Click Me!</button>
    <div id="output"></div>
  </div>
</body>
</html>`);

      cssEditor.setValue(`body {
  font-family: 'Arial', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

.container {
  background: white;
  padding: 40px;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  text-align: center;
}

h1 {
  color: #667eea;
  margin-bottom: 20px;
}

button {
  background: #667eea;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s;
}

button:hover {
  background: #764ba2;
}

#output {
  margin-top: 20px;
  font-size: 18px;
  color: #333;
}`);

      jsEditor.setValue(`document.getElementById('clickBtn').addEventListener('click', function() {
  const output = document.getElementById('output');
  const messages = [
    'üéâ Great job!',
    '‚ú® You clicked it!',
    'üöÄ Amazing!',
    'üí° Keep going!'
  ];
  const randomMsg = messages[Math.floor(Math.random() * messages.length)];
  output.textContent = randomMsg;
  output.style.color = '#667eea';
  output.style.fontWeight = 'bold';
});`);

      // Auto-update on change
      let updateTimeout;
      const debouncedUpdate = () => {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(updatePreview, 500);
      };

      htmlEditor.on('change', debouncedUpdate);
      cssEditor.on('change', debouncedUpdate);
      jsEditor.on('change', debouncedUpdate);
    }

    // Update preview
    function updatePreview() {
      const html = htmlEditor.getValue();
      const css = cssEditor.getValue();
      const js = jsEditor.getValue();

      const fullCode = `
<!DOCTYPE html>
<html>
<head>
  <style>${css}</style>
</head>
<body>
  ${html}
  <script>${js}<\/script>
</body>
</html>`;

      const iframe = previewFrame;
      iframe.srcdoc = fullCode;
    }

    // Open CodePen mode
    codepenBtn.addEventListener('click', () => {
      if (!htmlEditor) {
        initializeCodePenEditors();
      }
      codepenModal.classList.add('active');
      setTimeout(() => {
        htmlEditor.refresh();
        cssEditor.refresh();
        jsEditor.refresh();
        updatePreview();
      }, 100);
    });

    // Close CodePen mode
    codepenCloseBtn.addEventListener('click', () => {
      codepenModal.classList.remove('active');
    });

    // Run/Update preview
    codepenRunBtn.addEventListener('click', updatePreview);
    codepenRefreshBtn.addEventListener('click', updatePreview);
  </script>

</body>

</html>
